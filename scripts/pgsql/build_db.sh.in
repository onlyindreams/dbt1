#!/bin/sh
#this script can be used to build the database
set -x

. @TOPDIR@/scripts/pgsql/set_run_env.sh
if [ $# -lt 3 ]; then
        echo "usage: $0 <db_param> <redirect_tmp> <redirect_xlog> [-g -d <rdbms> -i <items> -u <eus> -p <path>]"
        exit 1
fi
db_param=$1
redirect_tmp=$2
redirect_xlog=$3
shift 3

if [ $# -ne 0 ] # Script invoked with command-line args
then
	getopts "g" Option
	if [ $Option != "g" ]
		then echo "usage: $0 <db_param> <redirect_tmp> <redirect_log> -g -d <rdbms> -i <items> -u <eus> -p <path>" 
		exit 1
	else
		if [ $# -ne 9 ]
			then echo "usage: $0 <db_param> <redirect_tmp> <redirect_log> -g -d <rdbms> -i <items> -u <eus> -p <path>" 
			exit 1
		else
			RDBMS=$3
			ITEMS=$5
			EUS=$7	
			DATA_PATH=$9
		fi
	fi
	echo "Generating data... $ITEMS item and $EUS eu"
	cd @TOPDIR@/datagen
	date
	@TOPDIR@/datagen/datagen -d $RDBMS -i $ITEMS -u $EUS -p $DATA_PATH
	echo "data file is generated"
	date
	cd @TOPDIR@/scripts/pgsql
else
	echo "build the database without generating the data file"
fi
	date
	echo "drop db"
	@TOPDIR@/scripts/pgsql/drop_db.sh
	echo
	
	date
	echo "create db"
	@TOPDIR@/scripts/pgsql/create_db.sh "$db_param"
	echo
	
	date
	echo "create tables"
	@TOPDIR@/scripts/pgsql/create_tables.sh
	echo
	
	date
	echo "load db"
	@TOPDIR@/scripts/pgsql/load_db.sh
	echo

	date
	echo "create indexes"
	@TOPDIR@/scripts/pgsql/create_indexes.sh
	echo
	
	date
	echo "create foreign key"
	@TOPDIR@/scripts/pgsql/create_fk.sh
	echo

#	date
#	echo "create prejoined tables for large database"
#	@TOPDIR@/scripts/pgsql/add_aux_structure.sh
#	echo
	
	date
	echo "load dbproc"
	@TOPDIR@/scripts/pgsql/load_dbproc.sh
	echo
	
	date
	echo "start updating optimizer statistics"
	@TOPDIR@/scripts/pgsql/update_statistics.sh
	date
        echo

	date

	if [ $redirect_tmp -eq 1 ]; then
		echo "create symbolic links for pgsql_tmp"
		for i in $PGDATA/base/*
		do
			#       if [$i > 17000]; then
			 dbdir=$i
		done

		rm -rf $dbdir/pgsql_tmp
		ln -s /db_tmp $dbdir/pgsql_tmp
	fi

	if [ $redirect_xlog -eq 1 ]; then
		echo "create symbolic links for pgsql_xlog"
		ln -s /db_xlog $PGDATA/pg_xlog_tmp
		mv $PGDATA/pg_xlog/* $PGDATA/pg_xlog_tmp
		rm -rf $PGDATA/pg_xlog
		mv $PGDATA/pg_xlog_tmp $PGDATA/pg_xlog
	fi

